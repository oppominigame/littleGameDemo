{"version":3,"sources":["Pay.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../assets/Script/pay","sourcesContent":["/**\n * @desc: 支付\n * @Create Date: 2019-08-28 17:59:07\n * @Last Modified time: 2019-08-29 14:57:41\n */\nconst { ccclass, property } = cc._decorator\n\n@ccclass\nexport default class Pay extends cc.Component {\n  @property(cc.Label)\n  logLabel: cc.Label = null\n\n  @property(cc.Node)\n  payBtn: cc.Node = null  \n  \n  @property(cc.EditBox)\n  moneyInput: cc.EditBox = null\n\n  @property(cc.Node)\n  returnBtn: cc.Node = null\n\n  start() {\n    this.payBtn.on(cc.Node.EventType.TOUCH_START, () => {\n      // 支付之前需要先登录\n      qg.login({\n        success: res => {\n          this.log(`登录成功: ${JSON.stringify(res.data)}`)\n          // 向自己的服务器发送支付请求\n          this.sendPayRequest(res.data.token)\n        },\n        fail: res => {\n          this.log(`登录失败: ${JSON.stringify(res)}`)\n        }\n      })\n    })\n    this.returnBtn.on(cc.Node.EventType.TOUCH_START, () => {\n      cc.director.loadScene('main')\n    })\n  }\n\n  sendPayRequest(token) {\n    let sendData = this.formatSendData(token)\n    let xhr = new XMLHttpRequest()\n    xhr.open(\n      'POST',\n      // 小游戏示例专用的服务器接口，完成统一下单接口的请求，CP 不可用\n      // 注：CP 需要自己搭建服务器接口，调用小游戏文档里的统一下单接口完成签名等操作后获取平台返回的时间戳、订单号、支付签名，再返回数据给小游戏发起支付\n      // 注：服务器向平台请求统一下单接口完成签名等操作具体可参考 server 文件夹里的代码\n      'https://jits.open.oppomobile.com/jitsopen/api/pay/demo/preOrder'\n      // 'http://172.17.171.28:3000/payResult'\n    )\n    xhr.setRequestHeader('Accept', 'application/json')\n    xhr.setRequestHeader('charset', 'UTF-8')\n\n    xhr.onreadystatechange = () => {\n      if (xhr.status === 200) {\n        // 获取服务器返回的数据后调用文档的发起支付接口\n        let data = JSON.parse(xhr.response).data\n        qg.pay({\n          appId: 30173650,\n          // 登录接口返回的token\n          token: token,\n          // 时间戳\n          timestamp: data.timestamp,\n          // 订单号\n          orderNo: data.orderNo,\n          // 支付签名，需要由服务器生成向平台发起统一下单接口后返回\n          paySign: data.paySign,\n          // 成功回调函数，结果以小游戏平台通知CP的回调地址为准\n          success: res => {\n            this.log(JSON.stringify(res))\n          },\n          fail: res => {\n            this.log(JSON.stringify(res))\n          }\n        })\n      } else {\n        this.log(JSON.parse(xhr.response))\n      }\n    }\n    xhr.send(JSON.stringify(sendData))\n  }\n\n  formatSendData(token) {\n    // 统一下单必填的数据（除了sign）\n    let dataObject = {\n      openId: token,\n      deviceInfo: '',\n      model: 'PAAM00',\n      ip: '10.102.217.239',\n      productName: '测试',\n      productDesc: 'testpay',\n      count: 1,\n      price: +this.moneyInput.string || 1, // 以分为单位\n      currency: 'CNY',\n      attach: '',\n      appVersion: '1.0.0',\n      engineVersion: '1045'\n    }\n    console.log(`--- sendData: ${JSON.stringify(dataObject)}`)\n    return dataObject\n  }\n\n  log(msg) {\n    console.log(msg)\n    this.logLabel.getComponent(cc.Label).string = msg\n  }\n}\n"]}